# ラボ7

- Polly: テキスト読み上げサービス
- S3: Pollyが生成した音声ファイル（MP3）を格納。署名付きURLによる一時的アクセスを提供。
- API Gateway: APIを作成
- Lambda: サーバーレスでコードを実行

# ラボを開始

- ラボ7を開始
- マネジメントコンソールにログイン
- 東京リージョンを選択

# S3バケットを作成

- サービス＞S3＞バケットを作成する
- バケット名「polly-123456」（番号部分は適当に）
- 後の操作のためにバケット名をテキストファイルにコピーしておく
- リージョン「アジアパシフィック（東京）」
- 「作成」

# IAMロールを作成

- サービス＞IAM＞ロール＞ロールの作成
- 「Lambda」
- 以下のポリシーをアタッチ
  - AmazonS3FullAccess
  - AmazonPollyFullAccess
  - AWSLambdaBasicExecutionRole
- タグは付けない
- ロール名「PollyRoleForLambda」、「ロールの作成」

# Lambda関数を作成

- （東京リージョンではない場合は、東京リージョンを選択）
- サービス＞Lambda＞関数の作成
- 「ーから作成」
- 関数名「polly_func」
- ランタイム「Python 3.7」
- アクセス権限＞実行ロールの選択または作成
- 実行ロール「既存のロールを使用する」
- 既存のロール「PollyRoleForLambda」
- 「関数の作成」
- 画面下にスクロール
- 「関数コード」のコードを削除し、別紙のコードを入力
- 「環境変数」の「キー」：「MP3_BUCKET_NAME」、値：コピーしたバケット名
- タイムアウト：「1分0秒」
- 画面上にスクロールして右上の「保存」をクリック

# API Gatewayをセットアップ

- （東京リージョンではない場合は、東京リージョンを選択）
- サービス＞API Gateway＞今すぐ始める（または「＋ APIの作成」ボタン）
- 「サンプルAPIの作成」ダイアログが出た場合は、「OK」
- 「新しいAPI」ラジオボタンを選択
- API名「polly_api」
- 「APIの作成」クリック
- 「アクション」＞メソッドの作成
- 「GET」を選択、その右のチェックマーク（灰色丸）をクリック
- 「Lambda プロキシ統合の使用」チェック
- 「Lambda関数」テキストボックスに「p」と打ち込む＞polly_funcを選択
- 「保存」
- 「Lambda 関数に権限を追加する」ダイアログが出た場合は、「OK」
- 「アクション」＞「APIのデプロイ」
- デプロイされるステージ：[新しいステージ]
- ステージ名：[dev]
- 「デプロイ」クリック

# Webブラウザからアクセス

- 「URLの呼び出し」に表示されたURLをクリック
- 新しいタブでURLが開かれる。Internal server errorとなる。
- URLの末尾に「?text=hello」と追加してエンター。
- (Firefoxの場合)SyntaxErrorが表示されるが、「生データ」をクリック
- 表示されたURL（S3の「署名付きURL」）を、新しいタブで開く。
- MP3がダウンロードされる。再生して確認。
